services:
  registry:
    image: 'registry:2'
    restart: unless-stopped
    volumes:
      - 'registry-data:/var/lib/registry'
    environment:
      REGISTRY_HTTP_SECRET: '${SERVICE_BASE64_REGISTRY}'

  openclaw:
    # On utilise la version stable officielle (beaucoup plus rapide à déployer)
   build:
    context: .
    args:
      - 'OPENCLAW_BETA=${OPENCLAW_BETA:-false}'

    restart: 'on-failure:10'
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - .env
    environment:
      # --- CONFIGURATION SYSTEME ---
      PORT: 18789
      HOME: /data
      # On force les dossiers de données dans le volume persistant
      OPENCLAW_STATE_DIR: /data/.openclaw
      OPENCLAW_WORKSPACE: /data/openclaw-workspace
      
      # --- CONFIGURATION RESEAU ---
      OPENCLAW_GATEWAY_PORT: '${OPENCLAW_GATEWAY_PORT:-18789}'
      BASE_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      PUBLIC_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      GATEWAY_TRUSTED_PROXIES: '*'
      
      # --- CONFIGURATION INTELLIGENCE (GROQ PAR DEFAUT) ---
      # On dit à OpenClaw d'utiliser le protocole OpenAI
      LLM_PROVIDER: 'openai'
      # On change l'adresse pour celle de Groq
      OPENAI_API_BASE: 'https://api.groq.com/openai/v1'
      # On injecte ta clé (qui sera définie dans les Secrets Coolify)
      OPENAI_API_KEY: '${OPENAI_API_KEY}'
      # On définit le modèle rapide par défaut
      LLM_MODEL: 'llama-3.1-8b-instant'
      
      # --- AUTRES CLES ---
      TELEGRAM_BOT_TOKEN: '${TELEGRAM_BOT_TOKEN}'
      
      # --- OPTIONS ---
      OPENCLAW_AUTO_BOOTSTRAP: '1'
      # Désactive le mode bac à sable complexe pour gagner en vitesse
      SANDBOX_CONTAINER: 'false'

    volumes:
      - 'openclaw-data:/data'
    depends_on:
      - docker-proxy
    command:
      - bash
      - /app/scripts/bootstrap.sh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/"]
      interval: 30s
      timeout: 10s
      retries: 3

  docker-proxy:
    image: 'tecnativa/docker-socket-proxy:latest'
    restart: unless-stopped
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
    environment:
      POST: 1
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      INFO: 1
      VERSION: 1
      EXEC: 1
      EVENTS: 1

  searxng:
    build:
      context: .
      dockerfile: searxng/Dockerfile
    restart: unless-stopped
    volumes:
      - 'searxng-data:/var/lib/searxng'
    environment:
      SEARXNG_BASE_URL: 'http://searxng:8080'
      SEARXNG_SERVER_SECRET_KEY: '${SERVICE_BASE64_SEARXNG}'
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

volumes:
  openclaw-data: null
  searxng-data: null
  registry-data: null
